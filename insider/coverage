#!/usr/bin/env bash
set -e
[ "$VERBOSE" -lt 1 ] || set -x

# Check addons exist
addons="$(addons list -ix $ADDON_CATEGORIES)" || exit 0

# Activate insider dependencies
venv="/qa/py$(python -c 'import sys; print(sys.version[0])')"
source $venv/bin/activate

# Test addons and report coverage
odoo="$(realpath "$(which odoo)")"
cd
coverage run \
    --source "$(addons list -ixf $ADDON_CATEGORIES)" \
    --omit '*/__openerp__.py,*/__manifest__.py' \
    "$odoo" --stop-after-init --workers 0 --test-enable -u "$addons"
coverage report --skip-covered
